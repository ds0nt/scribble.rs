
<!DOCTYPE html>
<html lang="en">

<head>
    <title>Connected Canadians Social Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <link rel="stylesheet" type="text/css" href="/resources/style.css"/>
    <link rel="stylesheet" type="text/css" href="/resources/lobby.css"/>
    <link rel="stylesheet" type="text/css" href="/resources/lobby_players.css"/>
    <link rel="icon" type="image/png" href="/resources/favicon.png"/>
</head>

<noscript><span class="noscript">Hey, seems like you've disabled JavaScript.
            I get it ... but you are trying to play an interactive drawing game
            here, so you have to turn on JavaScript.</span></noscript>

{{template "header"}}

<div id="lobby">
    <div class="mask">
        <p>Please </p>
        <p>turn</p>
        <p> the </p>
        <p>screen </p>
        <p>horizontally.</p>
    </div>
    <div class="timeBox">
        <span id="time-left">
            <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 56 56"><defs><style>.a{fill:none;}.b{fill:#cc362e;}</style></defs><rect class="a" width="56" height="56"/><g transform="translate(-1246 -236)"><g transform="translate(1252 236)"><path class="b" d="M29.361,957.365a1.867,1.867,0,0,0-1.672,1.867v6.222a1.867,1.867,0,0,0,1.866,1.866h1.867v1.808a22.4,22.4,0,1,0,9.956,0V967.32h1.867a1.867,1.867,0,0,0,1.867-1.866v-6.222a1.867,1.867,0,0,0-1.866-1.867H29.556a1.845,1.845,0,0,0-.194,0Zm2.061,3.733h9.956v2.489H31.422Zm3.733,6.222h2.489V968.6c-.413-.023-.826-.039-1.244-.039s-.832.016-1.244.039ZM36.4,972.3a18.666,18.666,0,1,1-18.667,18.666A18.638,18.638,0,0,1,36.4,972.3Zm-.019,1.205a1.867,1.867,0,0,0-1.847,1.906v1.245a1.867,1.867,0,0,0,3.734,0v-1.245a1.867,1.867,0,0,0-1.886-1.905Zm8.614,8.108a1.868,1.868,0,0,0-1.128.486l-6.611,5.891a3.043,3.043,0,0,0-.856-.136,3.111,3.111,0,1,0,3.111,3.13l6.844-6.105a1.867,1.867,0,0,0-1.361-3.267ZM20.65,989.1a1.869,1.869,0,1,0,.194,3.731h1.244a1.867,1.867,0,1,0,0-3.733H20.844a1.845,1.845,0,0,0-.194,0Zm29.867,0a1.869,1.869,0,1,0,.194,3.731h1.244a1.867,1.867,0,1,0,0-3.733H50.711a1.845,1.845,0,0,0-.194,0ZM36.38,1003.368a1.867,1.867,0,0,0-1.847,1.9v1.244a1.867,1.867,0,0,0,3.734,0v-1.244a1.867,1.867,0,0,0-1.886-1.906Z" transform="translate(-14 -957.362)"/></g></g></svg>
             <span>10</span>
        </span>
    </div>
    <div id="player-container">
       <div id="rounds"></div>
           <!-- <div class="playerBox self">
               <img src="../resources/image/avatar_hannah.png" alt="">
               <div class="playerName self">dora</div>
               <div class="playerScore">0</div>
           </div>
        <div class="playerBox">
            <img src="../resources/image/avatar_phillip.png" alt="">
            <div class="playerName self">james</div>
            <div class="playerScore">0</div>
        </div> -->

       </div>
    <div id="drawing-board-wrapper">
           <div id="word-container">
               <span class="guess-letter guess-letter-underline">Welcome</span>
           </div>
           <div id="drawing-board-inner-wrapper">
               <canvas id="drawing-board"></canvas>
               <div id="center-dialog">
                   <div id="word-dialog" class="center-dialog-content">
                       <span class="dialog-title">Choose a word to draw</span>
                       <div class="word-button-container">
                           <div id="word-button-zero" class="dialog-word-button" onclick="chooseWord(0)">Placeholder</div>
                           <div id="word-button-one" class="dialog-word-button" onclick="chooseWord(1)">Placeholder</div>
                           <div id="word-button-two" class="dialog-word-button" onclick="chooseWord(2)">Placeholder</div>
                       </div>
                   </div>
                   <div id="start-dialog" class="center-dialog-content">
                       <div class="dialog-button" onclick="startGame()">
                           <div></div>
                           <p>start game</p>
                       </div>
                   </div>
                   <div id="score-dialog" class="center-dialog-content">
                       <div class="score green">
                           <div class="score-box">
                               <div class="name">dora</div>
                               <img src="../resources/image/avatar_hannah.png" alt="">
                               <div class="score">+1123</div>
                           </div>
                           <div class="score-box">
                           <div class="name">dora</div>
                           <img src="../resources/image/avatar_hannah.png" alt="">
                           <div class="score">+1123</div>
                       </div>
                           <div class="score-box">
                               <div class="name">dora</div>
                               <img src="../resources/image/avatar_hannah.png" alt="">
                               <div class="score">+1123</div>
                           </div>
                           <div class="score-box">
                               <div class="name">dora</div>
                               <img src="../resources/image/avatar_hannah.png" alt="">
                               <div class="score">+1123</div>
                           </div>

                       </div>
                       <div class="score red">
                           <div class="score-box">
                               <div class="name">dora</div>
                               <img src="../resources/image/avatar_hannah.png" alt="">
                               <div class="score">0</div>
                           </div>
                           <div class="score-box">
                               <div class="name">dora</div>
                               <img src="../resources/image/avatar_hannah.png" alt="">
                               <div class="score">0</div>
                           </div>

                       </div>
                   </div>
               </div>
           </div>
        <div class="guess-input">
            <div class="guess-title">Type in box to guess:</div>
            <form class="message-input-form" onsubmit="return sendMessage()">
                <input id="message-input" type="text" autocomplete="off" placeholder="Type in box to guess:"/>
            </form>
        </div>
       </div>
    <div class="video-grid" id="video">
           <div class="video-view">
               <div id="local_stream" class="video-placeholder"></div>
           </div>
       </div>

     <div id="cc-toolbox">
         <div class="big-group">
             <div>
                 <div class="draw active" onclick="chooseTool(pen)">
                     <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"  viewBox="0 0 80 80"><defs><style>.a{fill:none;}</style></defs><rect class="a" width="80" height="80"/><path d="M72.8,19.4A3.651,3.651,0,0,0,70,18a4.193,4.193,0,0,0-2.8,1.4L24.3,62.3a.52.52,0,0,0-.2.4h0l-4,11.9v.1l-2,6a1.093,1.093,0,0,0,.2,1,.908.908,0,0,0,.7.3.367.367,0,0,0,.3-.1l18-6h0a.758.758,0,0,0,.4-.2L80.6,32.8A3.5,3.5,0,0,0,82,30a4.193,4.193,0,0,0-1.4-2.8ZM62,27.4,64.6,30,30.8,63.8a4.172,4.172,0,0,0-.9-1.6,3.669,3.669,0,0,0-1.7-1Zm4,4L68.6,34,34.8,67.8a4.2,4.2,0,0,0-2.6-2.6Zm-45.4,48,.9-2.6,1.7,1.7Zm15.9-5.3L25.3,77.8l-3.1-3.1,3.7-11.2A1.8,1.8,0,0,1,29,64.7a2.084,2.084,0,0,1-.7,1.5,1.33,1.33,0,0,0-.3.8.99.99,0,0,0,1.7.7,2.084,2.084,0,0,1,1.5-.7,1.656,1.656,0,0,1,1.2.5,1.845,1.845,0,0,1,.5,1.2,2.084,2.084,0,0,1-.7,1.5,2.353,2.353,0,0,0-.2.8.99.99,0,0,0,1.7.7,2.084,2.084,0,0,1,1.5-.7,1.656,1.656,0,0,1,1.2.5A1.849,1.849,0,0,1,36.5,74.1Zm2.3-2.4a3.36,3.36,0,0,0-1-1.6,3.915,3.915,0,0,0-1.6-1L70,35.4,72.6,38ZM79.2,31.4,74,36.6,63.4,26l5.2-5.2A2.275,2.275,0,0,1,70,20c.4,0,.6,0,1.4.8l7.8,7.8A2.275,2.275,0,0,1,80,30C80,30.4,79.9,30.6,79.2,31.4Z" transform="translate(-10.061 -10)"/></svg>
                     <p>Draw</p>
                 </div>
                 <div class="brush-group">
                     <div class="small-circle active" onclick="setLineWidth(15)"></div>
                     <div class="medium-circle" onclick="setLineWidth(30)"></div>
                     <div class="huge-circle" onclick="setLineWidth(40)"></div>
                     <div class="brush-size">
                         Brush Size
                     </div>
                 </div>
                 <div class="fill" onclick="chooseTool(fillBucket)">
                     <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80" style="margin-bottom: 1vh"><defs><style>.a{fill:none;}</style></defs><rect class="a" width="80" height="80"/><path d="M24.442,51.687c-2.766-.638-6.6-1.277-7.872,3.83-1.489,6.808,1.7,19.786,3.191,22.977,1.915,4.255,4.255-20.85,4.681-23.4L46.568,77.218a10.283,10.283,0,0,0,14.893,0L76.992,61.9a10.8,10.8,0,0,0,3.191-7.659,10.322,10.322,0,0,0-3.191-7.446L54.015,23.817a1,1,0,0,0-1.7,0l-1.064.851c-.638-2.766-1.7-5.957-3.191-7.446-1.7-1.489-4.042-1.064-4.893,4.042a34.907,34.907,0,0,0,.213,11.489Zm24.892-25.1L45.717,30.2a37.943,37.943,0,0,1,0-8.51C46.994,14.881,49.334,25.519,49.334,26.582Zm-5.319,9.148a7.177,7.177,0,0,0,.851,2.553,2.3,2.3,0,0,0,2.128,3.4,2.343,2.343,0,0,0,.213-4.681c-.426-1.064-.638-2.128-1.064-3.4l7.021-7.021L75.077,48.709c1.915,1.277,2.766,4.681,2.34,5.532l-51.061-.851Z"/></svg>
                     <p>Fill</p>
                 </div>
             </div>
             <div>
                 <div class="group-color">
                     <input class="show-color" type="color" id="color-picker" onchange="setColor()" value="#000000"
                            alt="Current color (Click to change)" title="Current color (Click to change)">
                 </div>
                 <div class="color-button-group">
                     <button class="color-button" style="background-color:#f0f4c3"
                             onclick="setColor('#f0f4c3')"></button>
                     <button class="color-button" style="background-color:#c1c1c1"
                             onclick="setColor('#c1c1c1')"></button>
                     <button class="color-button" style="background-color: #ef130b"
                             onclick="setColor('#ef130b')"></button>
                     <button class="color-button" style="background-color: #ff7100"
                             onclick="setColor('#ff7100')"></button>
                     <button class="color-button" style="background-color: #ffe400"
                             onclick="setColor('#ffe400')"></button>
                     <button class="color-button" style="background-color: #00cc00"
                             onclick="setColor('#00cc00')"></button>
                     <button class="color-button" style="background-color: #00b2ff"
                             onclick="setColor('#00b2ff')"></button>
                     <button class="color-button" style="background-color: #231fd3"
                             onclick="setColor('#231fd3')"></button>
                     <button class="color-button" style="background-color: #a300ba"
                             onclick="setColor('#a300ba')"></button>
                     <button class="color-button" style="background-color: #d37caa"
                             onclick="setColor('#d37caa')"></button>
                     <button class="color-button" style="background-color: #a0522d"
                             onclick="setColor('#a0522d')"></button>
                     <button class="color-button" style="background-color: #000000"
                             onclick="setColor('#000000')"></button>
                 </div>
                 <div class="erase" onclick="chooseTool(rubber)">
                     <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80"><defs><style>.a{fill:none;}</style></defs><g transform="translate(8 9)"><path d="M36.28,55.673a1.08,1.08,0,0,1-.768-.319L15.15,35a1.088,1.088,0,0,1,0-1.541L46.746,1.85a1.085,1.085,0,0,1,1.537,0L68.609,22.208a1.09,1.09,0,0,1,0,1.54L37.049,55.355A1.083,1.083,0,0,1,36.28,55.673ZM17.456,34.228,36.279,53.046,66.3,22.978,47.513,4.159Z" transform="translate(-4.927 -1.531)"/><path d="M19.58,83.3a8.071,8.071,0,0,1-5.722-2.365L.907,67.984a3.166,3.166,0,0,1,0-4.436l10.4-10.4a1.141,1.141,0,0,1,1.617,0L32.2,72.425a1.144,1.144,0,0,1,0,1.617l-6.9,6.9A8.074,8.074,0,0,1,19.58,83.3ZM12.114,55.574,2.522,65.165a.882.882,0,0,0,0,1.2h0L15.475,79.32a5.815,5.815,0,0,0,8.211,0l6.088-6.087Z" transform="translate(0 -21.262)"/><path d="M65.952,97.314h-37.6a1.143,1.143,0,1,1,0-2.286h37.6a1.143,1.143,0,0,1,0,2.286Z" transform="translate(-11.818 -35.286)"/><path d="M38.222,51.836a1.143,1.143,0,0,1-.808-1.95L63.2,24.057a1.143,1.143,0,0,1,1.617,1.616L39.031,51.5A1.136,1.136,0,0,1,38.222,51.836Z" transform="translate(-14.096 -9.994)"/><path d="M31.491,45.1a1.143,1.143,0,0,1-.808-1.95L56.472,17.326a1.143,1.143,0,0,1,1.617,1.616L32.3,44.768A1.136,1.136,0,0,1,31.491,45.1Z" transform="translate(-11.537 -7.427)"/><path d="M53.624,55.619a1.143,1.143,0,0,1-.808-1.951L67.024,39.459a1.143,1.143,0,1,1,1.617,1.616L54.432,55.284A1.14,1.14,0,0,1,53.624,55.619Z" transform="translate(-19.371 -15.422)"/></g><rect class="a" width="80" height="80"/></svg>
                     <p>Erase</p>
                 </div>
             </div>
         </div>
         <div class="small-group">
             <div class="clear" onclick="clearCanvasAndSendEvent()">
                 <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><g transform="translate(-17 -17)"><g transform="translate(17 17)"><path d="M56.455,20.091A1.682,1.682,0,0,0,57,18.818a1.78,1.78,0,0,0-.545-1.3A1.73,1.73,0,0,0,55.182,17a1.832,1.832,0,0,0-1.3.515L37,34.424,20.091,17.515A1.73,1.73,0,0,0,18.818,17,1.762,1.762,0,0,0,17,18.818a1.73,1.73,0,0,0,.515,1.273L34.424,37,17.515,53.879a1.832,1.832,0,0,0-.515,1.3,1.73,1.73,0,0,0,.515,1.273,1.78,1.78,0,0,0,1.3.545,1.682,1.682,0,0,0,1.273-.545L37,39.576,53.879,56.455a1.78,1.78,0,0,0,1.3.545A1.864,1.864,0,0,0,57,55.182a1.78,1.78,0,0,0-.545-1.3L39.576,37Z" transform="translate(-17 -17)"/></g></g></svg>
                 <p>Erase</p>
             </div>
             <div class="undo">
                 <svg xmlns="http://www.w3.org/2000/svg" width="35.556" height="40" viewBox="0 0 35.556 40"><g transform="translate(-30 -69.625)"><path d="M31.259,15.032H23.852V8.613a.989.989,0,0,0-1.6-.772l-9.877,7.9a.989.989,0,0,0,0,1.543l9.877,7.9a.989.989,0,0,0,1.6-.772V18h7.407a13.333,13.333,0,1,1,0,26.667h-15.8a1.481,1.481,0,0,0,0,2.963h15.8a16.3,16.3,0,1,0,0-32.593Z" transform="translate(18 62)"/></g></svg>
                 <p>Undo</p>
             </div>
         </div>
     </div>
</div>

<script type="text/javascript" src="/resources/floodfill.js"></script>
<script type="text/javascript">



    console.log("Attempting Connection on port " + location.port + "...");
    let socket;
    if (location.protocol === 'https:') {
        socket = new WebSocket("wss://" + location.hostname + ":" + location.port + "/v1/ws?lobby_id={{.LobbyID}}");
    } else {
        socket = new WebSocket("ws://" + location.hostname + ":" + location.port + "/v1/ws?lobby_id={{.LobbyID}}");
    }
    const messageInput = document.getElementById("message-input");
    const playerContainer = document.getElementById("player-container");
    const wordContainer = document.getElementById("word-container");
    const messageContainer = document.getElementById("message-container");
    const roundsSpan = document.getElementById("rounds");
    const timeLeft = document.getElementById("time-left");
    const drawingBoard = document.getElementById("drawing-board");
    //const chat = document.getElementById("chat");
    const colorPicker = document.getElementById("color-picker");
    const centerDialog = document.getElementById("center-dialog");

    const startDialog = document.getElementById("start-dialog");
    const wordDialog = document.getElementById("word-dialog");
    const wordButtonZero = document.getElementById("word-button-zero");
    const wordButtonOne = document.getElementById("word-button-one");
    const wordButtonTwo = document.getElementById("word-button-two");

   // const noSoundIcon = "üîá";
   // const soundIcon = "üîä";
   // const soundToggleLabel = document.getElementById("sound-toggle-label");
   // let sound = localStorage.getItem("sound") === "true";
  //  updateSoundIcon();

  /*  function toggleSound() {
        sound = !sound;
        localStorage.setItem("sound", sound.toString());
        updateSoundIcon();
    }

    function updateSoundIcon() {
        if (sound) {
            soundToggleLabel.innerText = soundIcon;
        } else {
            soundToggleLabel.innerText = noSoundIcon;
        }
    }*/

    //The drawing board has a base size. This base size results in a certain ratio
    //that the actual canvas has to be resized accordingly too. This is needed
    //since not every client has the same screensize.
    let baseWidth = {{.DrawingBoardBaseWidth}};
    let baseHeight = {{.DrawingBoardBaseHeight}};
    let boardRatio = baseWidth / baseHeight;

    function handleCanvasResize() {
        drawingBoard.width = drawingBoard.clientWidth;
        drawingBoard.height = drawingBoard.clientHeight;
        setLineWidth(localLineWidthUnscaled);
        // chat.style.maxHeight = drawingBoard.height + "px";
    }

    // Moving this here to extract the context after resizing
    const context = drawingBoard.getContext("2d");

    function scaleUpFactor() {
        return baseWidth / drawingBoard.clientWidth;
    }

    function scaleDownFactor() {
        return drawingBoard.clientWidth / baseWidth;
    }

    const pen = 0;
    const rubber = 1;
    const fillBucket = 2;

    let allowDrawing = false;
    let localColor = "#000000";
    let localLineWidth;
    let localLineWidthUnscaled;
    let localTool = pen;
    setLineWidth(5);

    function startGame() {
        socket.send(JSON.stringify({
            type: "start",
        }));
        //Tas: not needed
        //startDialog.style.display = "hidden";
        hide("#start-dialog");
        show("#word-dialog");
        wordDialog.style.display  = "block";
    }

    function setColor(value) {
        if (value === undefined) {
            localColor = colorPicker.value;
        } else {
            localColor = value;
            colorPicker.value = value;
        }
        document.documentElement.style.setProperty('--color', value);
        //updateCursor();
    }

    function setLineWidth(value) {
        localLineWidthUnscaled = value;
        localLineWidth = value * scaleDownFactor();
        updateCursor();
    }

    function chooseTool(value) {
        if (value === pen || value === rubber || value === fillBucket) {
            localTool = value;
        } else {
            //If this ends up with an invalid value, we use the pencil.
            localTool = pen;
        }
    }

    function hexToRgb(hex) {
        return hex.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i, (m, r, g, b) => '#' + r + r + g + g + b + b)
            .substring(1).match(/.{2}/g)
            .map(x => parseInt(x, 16));
    }

    function updateCursor() {
        let cursorColor;
        let borderColor = "#FFFFFF";
        if (localColor.startsWith("#")) {
            cursorColor = hexToRgb(localColor);

            const hsp = Math.sqrt(
                0.299 * (cursorColor[0] * cursorColor[0]) +
                0.587 * (cursorColor[1] * cursorColor[1]) +
                0.114 * (cursorColor[2] * cursorColor[2])
            );

            if (hsp > 127.5) {
                borderColor = "rgb(0,0,0)";
            } else {
                borderColor = "rgb(255,255,255)";
            }

            cursorColor = "rgb(" + cursorColor[0] + "," + cursorColor[1] + "," + cursorColor[2] + ")";
        } else {
            cursorColor = localColor;
        }

        let circleSize = localLineWidth * scaleUpFactor();
        drawingBoard.style.cursor = "url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\" width=\"" + (circleSize + 2) + "\" height=\"" + (circleSize + 2) + "\"><circle cx=\"" + (circleSize / 2) + "\" cy=\"" + (circleSize / 2) + "\" r=\"" + (circleSize / 2) + "\" style=\"fill: " + cursorColor + "; stroke: " + borderColor + ";\"/></svg>') " + (circleSize / 2) + " " + (circleSize / 2) + ", auto";
    }

    function clearCanvasAndSendEvent() {
        //Avoid unnecessary traffic back to us.
        clear(context);
        socket.send(JSON.stringify({
            type: "clear-drawing-board"
        }));
    }

    const sendMessage = () => {
        socket.send(JSON.stringify({
            type: "message",
            data: messageInput.value
        }));
        messageInput.value = "";

        // Necessary in order to keep the page from submitting.
        return false;
    };

    function chooseWord(index) {
        socket.send(JSON.stringify({
            type: "choose-word",
            data: index
        }));
        allowDrawing = true;
        hide("#word-dialog");
        wordDialog.style.visibility = "hidden";
        $("#cc-toolbox").css({'transform':'translateX(0)'});
        $("#player-container").css({'transform':'translateX(-150%)'});
    }

    function onClickKickButton(playerId) {
        socket.send(JSON.stringify({
            type: "kick-vote",
            data: playerId
        }));
    }

    socket.onopen = () => console.log("Successfully Connected");

    let ownID, ownerID;
    let maxRounds = 0;
    let roundEndTime = 0;
    socket.onmessage = event => {
        let parsed = JSON.parse(event.data);
        if (parsed.type === "ready") {
            let ready = parsed.data;
            ownerID = ready.ownerId;
            allowDrawing = ready.drawing;
            ownID = ready.playerId;
            maxRounds = ready.maxRounds;
            roundEndTime = ready.roundEndTime;
            applyRounds(ready.round, ready.maxRounds);

            if (ready.round === 0 && ownerID === ownID) {
                show("#start-dialog")
                //startDialog.style.visibility = "visible";
            }

            if (ready.players && ready.players.length) {
                applyPlayers(ready.players)
            }
            if (ready.currentDrawing && ready.currentDrawing.length) {
                applyDrawData(ready.currentDrawing)
            }
            if (ready.wordHints && ready.wordHints.length) {
                applyWordHints(ready.wordHints)
            }
        }
        if (parsed.type === "update-players") {
            applyPlayers(parsed.data);
        } else if (parsed.type === "correct-guess") {
            playWav('/resources/plop.wav');
        } else if (parsed.type === "update-wordhint") {
            applyWordHints(parsed.data);
        } else if (parsed.type === "message") {
            applyMessage("", parsed.data.author, parsed.data.content);
        } else if (parsed.type === "system-message") {
            applyMessage("system-message", "System", parsed.data);
        } else if (parsed.type === "non-guessing-player-message") {
            applyMessage("non-guessing-player-message", parsed.data.author, parsed.data.content);
        } else if (parsed.type === "persist-username") {
            document.cookie = "username=" + parsed.data + ";expires=Tue, 19 Jan 2038 00:00:00 UTC;path=/;samesite=strict";
        } else if (parsed.type === "reset-username") {
            document.cookie = "username=; expires=Thu, 01 Jan 1970 00:00:00 GMT";
        } else if (parsed.type === "line") {
            drawLine(context, parsed.data.fromX * scaleDownFactor(), parsed.data.fromY * scaleDownFactor(), parsed.data.toX * scaleDownFactor(), parsed.data.toY * scaleDownFactor(), parsed.data.color, parsed.data.lineWidth * scaleDownFactor());
        } else if (parsed.type === "fill") {
            fill(context, parsed.data.x * scaleDownFactor(), parsed.data.y * scaleDownFactor(), parsed.data.color);
        } else if (parsed.type === "clear-drawing-board") {
            clear(context)
        } else if (parsed.type === "next-turn") {
            $("#cc-toolbox").css({'transform':'translateX(-150%)'});
            $("#player-container").css({'transform':'translateX(0)'});
            //If a player doesn't choose, the dialog will still be up.
            wordDialog.style.visibility = "hidden";
            playWav('/resources/end-turn.wav');

            clear(context);

            roundEndTime = parsed.data.roundEndTime;
            applyRounds(parsed.data.round, maxRounds);
            applyPlayers(parsed.data.players);

            //We clear this, since there's no word chosen right now.
            wordContainer.innerHTML = "";

            allowDrawing = false;
        } else if (parsed.type === "your-turn") {
            playWav('/resources/your-turn.wav');

            promptWords(parsed.data[0], parsed.data[1], parsed.data[2]);
        }
    };

    socket.onclose = event => console.log("Socket Closed Connection: ", event);
    socket.onerror = error => console.log("Socket Error: ", error);

    function promptWords(wordOne, wordTwo, wordThree) {
        wordButtonZero.textContent = wordOne;
        wordButtonOne.textContent = wordTwo;
        wordButtonTwo.textContent = wordThree;
        //wordDialog.style.visibility = "visible";
        show("#word-dialog");
    }

    function playWav(file) {
        //Tas: add this ine
        if (true) {
            let audio = new Audio(file);
            audio.type = 'audio/wav';
            audio.play();
        }
    }

    window.setInterval(function () {
        let secondsLeft = Math.floor((roundEndTime - new Date().getTime()) / 1000);
        if (secondsLeft >= 0) {
            timeLeft.innerText = secondsLeft;
        } else {
           timeLeft.innerText = "‚àû";
        }
    }, 500);

    function applyMessage(styleClass, author, message) {
        if (messageContainer.childElementCount >= 100) {
            messageContainer.removeChild(messageContainer.firstChild)
        }

        messageContainer.innerHTML += `<div class="message ` + styleClass + `">
                            <span class="chat-name">` + author + `</span>
                            <span class="message-content">` + message + `</span>
                        </div>`;
    }

    // <div class="playerBox">
    //         <img src="../resources/image/avatar_phillip.png" alt="">
    //         <div class="playerName self">james</div>
    //         <div class="playerScore">0</div>
    //     </div> 
    function applyPlayers(players) {
        playerContainer.innerHTML = "";
        players.forEach(function (player) {
            //We don't wanna show the disconnected players.
            if (!player.connected) {
                return;
            }

            let stateStyleClass;
            if (player.state === 2) {
                stateStyleClass = 'player-done';
            } else {
                stateStyleClass = '';
            }
            let newPlayerElement = '<div class="playerBox">' +
                ' <img src="../resources/image/avatar_phillip.png" alt="">' +
                '<span class="playername';
            //Tas: not sure if we need to add this
                // if (player.id === ownID) {
            //     newPlayerElement += ' playername-self';
            // }
            newPlayerElement += '">' + player.name + '</span>';
            if (player.id !== ownID) {
                newPlayerElement +=
                    '<button class="kick-button" id="kick-button" type="button" title="Vote to kick this player" alt="Vote to kick this player" onclick="onClickKickButton(' + player.id + ')">üëã</button>';
            }
            newPlayerElement +=
                '<span class="playerscore">' + player.score + '</span>' +
                '<span class="last-turn-score">(Last turn: ' + player.lastScore + ')</span>' +
                '</div>';
            if (player.state === 1) {
                newPlayerElement += '<span>‚úèÔ∏è</span>';
            } else if (player.state === 2) {
                newPlayerElement += '<span>‚úîÔ∏è</span>';
            }
            newPlayerElement += '</div></div></div>';
            let newPlayer = document.createRange().createContextualFragment(newPlayerElement);
            console.log(newPlayer);
            playerContainer.appendChild(newPlayer);
            //playerContainer.innerHTML += newPlayerElement;

        });
    }

    function applyRounds(round, maxRound) {
        roundsSpan.innerText = 'Round ' + round + ' of ' + maxRound;
    }

    function applyWordHints(wordHints) {
        wordContainer.innerHTML = "";
        //If no hint has been revealed
        wordHints.forEach(function (hint) {
            if (hint.character === 0) {
                wordContainer.innerHTML += '<span class="guess-letter guess-letter-underline">&nbsp;</span>';
            } else {
                let char = String.fromCharCode(hint.character);
                if (hint.underline) {
                    wordContainer.innerHTML += '<span class="guess-letter guess-letter-underline">' + char + '</span>'
                } else {
                    wordContainer.innerHTML += '<span class="guess-letter">' + char + '</span>';
                }
            }
        });
    }

    function applyDrawData(drawElements) {
        clear(context);
        drawElements.forEach(function (drawElement) {
            let drawData = drawElement.data;
            if (drawElement.type === "fill") {
                fill(context, drawData.x * scaleDownFactor(), drawData.y * scaleDownFactor(), drawData.color);
            } else if (drawElement.type === "line") {
                drawLine(context, drawData.fromX * scaleDownFactor(), drawData.fromY * scaleDownFactor(), drawData.toX * scaleDownFactor(), drawData.toY * scaleDownFactor(), drawData.color, drawData.lineWidth * scaleDownFactor());
            } else {
                console.log("Unknown draw element type: " + drawData.type)
            }
        });
    }

    let isDrawing = false;
    let x = 0;
    let y = 0;

    // Touch input
    let touchID = 0;

    drawingBoard.ontouchstart = function (e) {
        if (!isDrawing && allowDrawing) {
            touchID = e.touches[0].identifier;

            if (allowDrawing && localTool !== 2) {
                // calculate the offset coordinates based on client touch position and drawing board client origin
                let clientRect = drawingBoard.getBoundingClientRect();
                x = (e.touches[0].clientX - clientRect.left);
                y = (e.touches[0].clientY - clientRect.top);

                isDrawing = true;
            }
        }
    };

    drawingBoard.ontouchmove = function (e) {
        //FIXME Explanation? Does this prevent moving the page?
        e.preventDefault();

        if (allowDrawing && isDrawing) {
            // find touch with correct ID
            for (let i = e.changedTouches.length - 1; i >= 0; i--) {
                if (e.changedTouches[i].identifier === touchID) {
                    let touch = e.changedTouches[i];

                    // calculate the offset coordinates based on client touch position and drawing board client origin
                    let clientRect = drawingBoard.getBoundingClientRect();
                    let offsetX = (touch.clientX - clientRect.left);
                    let offsetY = (touch.clientY - clientRect.top);

                    // drawing functions must check for context boundaries
                    drawLineAndSendEvent(context, x, y, offsetX, offsetY, localColor, localLineWidth);
                    x = offsetX;
                    y = offsetY;

                    return;
                }
            }
        }
    };

    function onTouchEnd(e) {
        if (isDrawing) {
            // find touch with correct ID
            for (let i = e.changedTouches.length - 1; i >= 0; i--) {
                if (e.changedTouches[i].identifier === touchID) {
                    isDrawing = false;
                    return;
                }
            }
        }
    }

    drawingBoard.ontouchend = onTouchEnd;
    drawingBoard.ontouchcancel = onTouchEnd;

    // Mouse input
    drawingBoard.onmousedown = function (e) {
        if (allowDrawing && e.button === 0 && localTool !== 2) {
            x = e.offsetX;
            y = e.offsetY;

            isDrawing = true;
        }

        return false;
    };

    // This is executed even if the mouse is not above the browser anymore.
    window.onmouseup = function (e) {
        if (isDrawing === true) {
            isDrawing = false;
        }
    };

    drawingBoard.onmousemove = function (e) {
        if (allowDrawing && isDrawing === true && e.button === 0) {
            // calculate the offset coordinates based on client mouse position and drawing board client origin
            let clientRect = drawingBoard.getBoundingClientRect();
            let offsetX = (e.clientX - clientRect.left);
            let offsetY = (e.clientY - clientRect.top);

            // drawing functions must check for context boundaries
            drawLineAndSendEvent(context, x, y, offsetX, offsetY, localColor, localLineWidth);
            x = offsetX;
            y = offsetY;
        }
    };

    // necessary for mousemove to not use the previous exit coordinates.
    drawingBoard.onmouseenter = function (e) {
        x = e.offsetX;
        y = e.offsetY;
    };

    drawingBoard.onclick = function (e) {
        if (allowDrawing && e.button === 0) {
            if (localTool === 2) {
                fillAndSendEvent(context, e.offsetX, e.offsetY, localColor)
            } else {
                drawLineAndSendEvent(context, e.offsetX, e.offsetY, e.offsetX, e.offsetY, localColor, localLineWidth);
            }
            isDrawing = false;
        }
    };

    function clear(context) {
        context.fillStyle = "#FFFFFF";
        context.fillRect(0, 0, drawingBoard.width, drawingBoard.height);
    }

    function fill(context, x1, y1, color) {
        context.fillStyle = color;
        //There seems to be some bug where setting the tolerance to 0 causes a freeze when painting black on white.
        context.fillFlood(x1, y1, 1);
    }

    function fillAndSendEvent(context, x1, y1, color) {
        fill(context, x1, y1, color);
        let fillInstruction = {
            type: "fill",
            data: {
                x: x1 * scaleUpFactor(),
                y: y1 * scaleUpFactor(),
                color: color
            },
        };
        socket.send(JSON.stringify(fillInstruction));
    }

    function drawLineAndSendEvent(context, x1, y1, x2, y2, color, lineWidth) {
        if (localTool === 1) {
            color = "#ffffff";
        }

        drawLine(context, x1, y1, x2, y2, color, lineWidth);

        let drawInstruction = {
            type: "line",
            data: {
                fromX: x1 * scaleUpFactor(),
                fromY: y1 * scaleUpFactor(),
                toX: x2 * scaleUpFactor(),
                toY: y2 * scaleUpFactor(),
                color: color,
                lineWidth: lineWidth * scaleUpFactor(),
            }
        };
        socket.send(JSON.stringify(drawInstruction));
    }

    function drawLine(context, x1, y1, x2, y2, color, lineWidth) {
        // the coordinates must be whole numbers to improve performance.
        // also, decimals as coordinates is not making sense.
        // FIXME quick and dirty fix to apply the window scale to all drawing activities.
        x1 = Math.floor(x1);
        y1 = Math.floor(y1);
        x2 = Math.floor(x2);
        y2 = Math.floor(y2);
        lineWidth = Math.ceil(lineWidth);

        color = hexToRgb(color);
        color[3] = 255; //alpha channel

        const circleMap = generateCircleMap(Math.floor(lineWidth / 2));
        const offset = Math.floor(circleMap.length / 2);
        const imageData = context.getImageData(0, 0, context.canvas.clientWidth, context.canvas.clientHeight);

        for (let ix = 0; ix < circleMap.length; ix++) {
            for (let iy = 0; iy < circleMap[ix].length; iy++) {
                if (circleMap[ix][iy] === 1 || (x1 === x2 && y1 === y2 && circleMap[ix][iy] === 2)) {
                    const newX1 = x1 + ix - offset;
                    const newY1 = y1 + iy - offset;
                    const newX2 = x2 + ix - offset;
                    const newY2 = y2 + iy - offset;
                    drawBresenhamLine(imageData, newX1, newY1, newX2, newY2, color);
                }
            }
        }
        context.putImageData(imageData, 0, 0);
    }

    function drawBresenhamLine(imageData, x0, y0, x1, y1, color) {
        const dx = Math.abs(x1 - x0);
        const dy = Math.abs(y1 - y0);
        const sx = (x0 < x1) ? 1 : -1;
        const sy = (y0 < y1) ? 1 : -1;
        let err = dx - dy;

        while (true) {
            //check if pixel is inside the canvas
            if (x0 < 0 || x0 >= imageData.width || y0 < 0 || y0 >= imageData.height) return;
            setPixel(imageData, x0, y0, color);

            if ((x0 === x1) && (y0 === y1)) break;
            const e2 = 2 * err;
            if (e2 > -dy) {
                err -= dy;
                x0 += sx;
            }
            if (e2 < dx) {
                err += dx;
                y0 += sy;
            }
        }
    }

    function generateCircleMap(radius) {
        let circleData = [];

        for (x = 0; x < 2 * radius; x++) {
            circleData[x] = [];
            for (y = 0; y < 2 * radius; y++) {
                const distanceToRadius = Math.sqrt(Math.pow(radius - x, 2) + Math.pow(radius - y, 2));
                if (distanceToRadius > radius) {
                    circleData[x][y] = 0;
                } else if (distanceToRadius < radius - 2) {
                    //optimize for performance: fill circle only when mouse was not moved
                    circleData[x][y] = 2;
                } else {
                    circleData[x][y] = 1;
                }
            }
        }

        return circleData;
    }

    function setPixel(imageData, x, y, color) {
        const offset = (y * imageData.width + x) * 4;
        imageData.data[offset] = color[0];
        imageData.data[offset + 1] = color[1];
        imageData.data[offset + 2] = color[2];
        imageData.data[offset + 3] = color[3];
    }

    //Call intially to correct initial state
    handleCanvasResize();
    window.addEventListener("resize", handleCanvasResize, false);
</script>
    <script type="text/javascript" src="/resources/agora/jquery.min.js"></script> <!--jquery-->
    <script type="text/javascript" src="/resources/agora/materialize.min.js"></script> <!--Materialize-->
    <script type="text/javascript" src="/resources/agora/AgoraRTCSDK-3.0.2.js"></script> <!--agora SDK-->
    <script type="text/javascript" src="/resources/agora/agora.js"></script> <!--agora SDK Commands-->
    <script>
        const video=new Video(
            {
                //appId, token, channel are from agora
                //appID
                appID:"5f05c8ce1679426aac75f20b14e83bfc", //replace with app ID,
                //TOKEN will need to be generated by server (agora docs have a walkthrough)
                token:"0065f05c8ce1679426aac75f20b14e83bfcIABpX9EZpCdpd84l6Ou9intToL7gMJnR40r/c4O1V7IXevfI+dsAAAAAEADxMb4b00fWXgEAAQDKR9Ze", //replace with channel token,
                //Channel will be what varies from lobby to lobby (works alongside the token)
                channel:"1111", //replace with channel name (linked with token),
                mode:"live",
                codec:"h264"
            }
        );
    </script>
    <script>
        //listrener screen size
        window.addEventListener("resize",()=>{
            window.innerWidth<window.innerHeight?$(".mask").css("display","flex"):$(".mask").css("display","none");
        });

        window.addEventListener('load', function () {
            video.joinVideo();
});
        //switch to tool and playlist
        //Tas: comment out
        /*setTimeout(()=>{
            $("#cc-toolbox").css({'transform':'translateX(0)'});
            $("#player-container").css({'transform':'translateX(-150%)'});
        },500);

        setTimeout(()=>{
            $("#cc-toolbox").css({'transform':'translateX(-150%)'});
            $("#player-container").css({'transform':'translateX(0)'});
        },3000);

       // show start game
        setTimeout(()=>{
            show("#start-dialog")
        },10);
        setTimeout(()=>{
            hide("#start-dialog")
        },1000);
        //show choose word dialog
        setTimeout(()=>{
            show("#word-dialog")
        },2000);
        setTimeout(()=>{
            hide("#word-dialog")
        },4000);
        // show result
        setTimeout(()=>{
            show("#score-dialog");
        },5000);
        setTimeout(()=>{
            hide("#score-dialog")
        },6000);
*/
        //show and hide
        function show(a) {
            $(a).css("display","block");
            $("#center-dialog").css("display","block");
        };
        function hide(a) {
            $(a).css("display","none");
            $("#center-dialog").css("display","none");
        };
    </script>
</body>

</html>
